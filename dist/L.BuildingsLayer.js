(function(a){function w(g,b){var n=g[0]-b[0],h=g[1]-b[1];return n*n+h*h}function Ea(g){for(var b=0,n=0,h=0,a=g.length-3;h<a;h+=2)b+=g[h],n+=g[h+1];g=2*(g.length-2);return[b/g<<0,n/g<<0]}function Fa(g){var b=g.length/2,n=new aa(b),a=0,k=b-1,r,e,j,B,w=[],F=[],H=[];for(n[a]=n[k]=1;k;){e=0;for(r=a+1;r<k;r++){j=g[2*r];var q=g[2*r+1],m=g[2*a],y=g[2*a+1],E=g[2*k],z=g[2*k+1],J=E-m,u=z-y,G=void 0;if(0!==J||0!==u)G=((j-m)*J+(q-y)*u)/(J*J+u*u),1<G?(m=E,y=z):0<G&&(m+=J*G,y+=u*G);J=j-m;u=q-y;j=J*J+u*u;j>e&&(B=
r,e=j)}2<e&&(n[B]=1,w.push(a),F.push(B),w.push(B),F.push(k));a=w.pop();k=F.pop()}for(r=0;r<b;r++)n[r]&&H.push(g[2*r],g[2*r+1]);return H}var Ga=Ga||Array,aa=aa||Array,e=Math,Qa=e.exp,Ra=e.log,Sa=e.sin,Ta=e.cos,xa=e.tan,Ua=e.atan,da=e.min,ya=e.max,pa=document,j,Ha=function(g){var b,a,h;if(0===g.s)b=a=h=g.l;else{h=0.5>g.l?g.l*(1+g.s):g.l+g.s-g.l*g.s;var k=2*g.l-h;g.h/=360;b=Y(k,h,g.h+1/3);a=Y(k,h,g.h);h=Y(k,h,g.h-1/3)}return new j(255*b<<0,255*a<<0,255*h<<0,g.a)},Y=function(g,b,a){0>a&&(a+=1);1<a&&(a-=
1);return a<1/6?g+6*(b-g)*a:0.5>a?b:a<2/3?g+6*(b-g)*(2/3-a):g},e=function(a,b,n,h){this.r=a;this.g=b;this.b=n;this.a=4>arguments.length?1:h},T=e.prototype;T.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};T.adjustLightness=function(a){var b=j.toHSLA(this);b.l*=a;b.l=Math.min(1,Math.max(0,b.l));return Ha(b)};T.adjustAlpha=function(a){return new j(this.r,this.g,this.b,this.a*a)};e.parse=function(a){var b;a+="";if(~a.indexOf("#"))return b=a.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),
new j(parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16),b[4]?parseInt(b[4],16)/255:1);if(b=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new j(parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10),b[4]?parseFloat(b[5]):1);if(b=a.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return Ha({h:parseInt(b[1],10),s:parseFloat(b[2]),l:parseFloat(b[3]),a:b[4]?parseFloat(b[5]):1})};e.toHSLA=function(a){var b=a.r/255,n=a.g/255,h=a.b/255,k=Math.max(b,n,h),e=Math.min(b,n,h),
j,B=(k+e)/2,m;if(k===e)j=e=0;else{m=k-e;e=0.5<B?m/(2-k-e):m/(k+e);switch(k){case b:j=(n-h)/m+(n<h?6:0);break;case n:j=(h-b)/m+2;break;case h:j=(b-n)/m+4}j/=6}return{h:360*j,s:e,l:B,a:a.a}};j=e;var Ia,e=Math,z=e.sin,O=e.cos,Va=e.tan,Ja=e.asin,Ka=e.atan2,U=e.PI,q=180/U,Wa=357.5291/q,Xa=0.98560028/q,Ya=1.9148/q,Za=0.02/q,$a=3E-4/q,ab=102.9372/q,La=23.45/q,bb=280.16/q,cb=360.9856235/q;Ia=function(a,b,e){e=-e/q;b/=q;a=a.valueOf()/864E5-0.5+2440588;var h=Wa+Xa*(a-2451545),j=Ya*z(h)+Za*z(2*h)+$a*z(3*h),
j=h+ab+j+U,h=Ja(z(j)*z(La)),j=Ka(z(j)*O(La),O(j));e=bb+cb*(a-2451545)-e-j;return{altitude:Ja(z(b)*z(h)+O(b)*O(h)*O(e)),azimuth:Ka(z(e),O(e)*z(b)-Va(h)*O(b))-U/2}};var ea=Math.PI,Ma=ea/2,db=ea/4,eb=180/ea,fb=256,za=14,fa="latitude",ga="longitude",Na=3,Oa=4,F=0,B=1,H=2,m=3,qa=4,V=5,P=6;a.OSMBuildings=function(g){function b(c,I){var d={};c/=ha;I/=ha;d[fa]=0>=I?90:1<=I?-90:eb*(2*Ua(Qa(ea*(1-2*I)))-Ma);d[ga]=360*(1===c?1:(c%1+1)%1)-180;return d}function e(){if(T&&!(K<za)){var c=b(u-X,G-J),I=b(u+y+X,G+
E+J);ra&&ra.abort();var d={w:c[ga],n:c[fa],e:I[ga],s:I[fa],z:K},c=T.replace(/\{ *([\w_]+) *\}/g,function(c,I){return d[I]}),a=h,f=new XMLHttpRequest;f.onreadystatechange=function(){4===f.readyState&&f.status&&!(200>f.status||299<f.status)&&f.responseText&&a(JSON.parse(f.responseText))};f.open("GET",c);f.send(null);ra=f}}function h(c){var I,d,a,f,b=[],e=d=0;Z=za;z(K);ra=null;if(c&&c.meta.z===K){f=c.meta;a=c.data;if(A&&p&&A.z===f.z){d=A.x-f.x;e=A.y-f.y;c=0;for(I=p.length;c<I;c++)b[c]=p[c][H][0]+d+","+
(p[c][H][1]+e)}A=f;p=[];c=0;for(I=a.length;c<I;c++)if(f=[],!(a[c][B]>ia)&&(d=Fa(a[c][H]),!(8>d.length))){f[H]=d;f[qa]=Ea(d);f[F]=da(a[c][F],ia);f[B]=a[c][B];d=f[H][0]+","+f[H][1];f[V]=!(b&&~b.indexOf(d));f[m]=[];f[P]=[];d=a[c][Na]?j.parse(a[c][Na]):null;e=a[c][Oa]?j.parse(a[c][Oa]):null;f[m]=[d||null,d?d.adjustLightness(0.8):null,e?e:d?d.adjustLightness(1.2):R];for(d=0;3>d;d++)f[m][d]&&(f[P][d]=f[m][d].adjustAlpha(N)+"");p.push(f)}O()}}function k(c,a){var d,b,f=[],e,g,C,l,h,j,M,p,sa=Aa-K;e=0;for(g=
c.length;e<g;e++)if(h=c[e],M=h[B]>>sa,!(M>ia)){j=h[H];p=new Ga(j.length);C=0;for(l=j.length-1;C<l;C+=2)d=j[C+1],b=da(1,ya(0,0.5-Ra(xa(db+Ma*j[C]/180))/ea/2)),d=(d/360+0.5)*ha<<0,b=b*ha<<0,p[C]=d,p[C+1]=b;p=Fa(p);if(!(8>p.length)){l=[];l[H]=p;l[qa]=Ea(p);l[F]=da(h[F]>>sa,ia);l[B]=M;l[V]=a;l[m]=h[m];l[P]=[];for(C=0;3>C;C++)l[m][C]&&(l[P][C]=l[m][C].adjustAlpha(N)+"");f.push(l)}}return f}function r(c,a,d){void 0===d&&(d=[]);var b,f,e,g=c[0]?c:c.features,C,l,h,p,M,k,sa=a?1:0,x=a?0:1;if(g){c=0;for(b=g.length;c<
b;c++)r(g[c],a,d);return d}"Feature"===c.type&&(b=c.geometry,l=c.properties);"Polygon"===b.type&&(C=[b.coordinates]);"MultiPolygon"===b.type&&(C=b.coordinates);if(C){p=l.height;if(l.color||l.wallColor)M=j.parse(l.color||l.wallColor);l.roofColor&&(k=j.parse(l.roofColor));c=0;for(b=C.length;c<b;c++){a=C[c][0];h=[];f=g=0;for(e=a.length;f<e;f++)h.push(a[f][sa],a[f][x]),g+=p||a[f][2]||0;if(g){e=f=[];var s=H;for(var t=void 0,v=void 0,n=void 0,A=void 0,y=0,u=void 0,z=void 0,u=0,z=h.length-3;u<z;u+=2)t=h[u],
v=h[u+1],n=h[u+2],A=h[u+3],y+=t*A-n*v;if("CW"!==(0<y/2?"CW":"CCW")){t=[];for(v=h.length-2;0<=v;v-=2)t.push(h[v],h[v+1]);h=t}e[s]=h;f[F]=g/a.length<<0;f[B]=l.minHeight;f[m]=[M||null,M?M.adjustLightness(0.8):null,k?k:M?M.adjustLightness(1.2):R];d.push(f)}}}return d}function q(c,a){c?(ja=r(c,a),Z=0,z(K),A={n:90,w:-180,s:-90,e:180,x:0,y:0,z:K},p=k(ja,!0),O()):(ja=null,ca())}function z(c){var a,d,b;K=c;ha=fb<<K;c=K;a=Z;d=Aa;c=da(ya(c,a),d);N=1-da(ya(0+0.4*((c-a)/(d-a)),0),0.4);U=S.adjustAlpha(N)+"";Ba=
ta.adjustAlpha(N)+"";ka=R.adjustAlpha(N)+"";if(p){c=0;for(a=p.length;c<a;c++){b=p[c];b[P]=[];for(d=0;3>d;d++)b[m][d]&&(b[P][d]=b[m][d].adjustAlpha(N)+"")}}}function O(){clearInterval(Ca);Q=0;ua.render();Ca=setInterval(function(){Q+=0.1;if(1<Q){clearInterval(Ca);Q=1;for(var c=0,a=p.length;c<a;c++)p[c][V]=0}va.render();ca()},33)}function ba(){va.render();ua.render();ca()}function ca(){D.clearRect(0,0,y,E);if(A&&p&&!(K<Z||la)){var c,a,d,b,f,e,g,h,l,j=u-A.x,Pa=G-A.y,M=ua.getMaxHeight(),k=[ma+j,na+Pa],
m,x,s,t,v,n;p.sort(function(c,a){return w(a[qa],k)/a[F]-w(c[qa],k)/c[F]});c=0;for(a=p.length;c<a;c++)if(f=p[c],!(f[F]<=M)){x=!1;e=f[H];m=[];d=0;for(b=e.length-1;d<b;d+=2)m[d]=h=e[d]-j,m[d+1]=l=e[d+1]-Pa,x||(x=0<h&&h<y&&0<l&&l<E);if(x){d=f[V]?f[F]*Q:f[F];e=$/($-d);f[B]&&(d=f[V]?f[B]*Q:f[B],g=$/($-d));h=[];D.strokeStyle="#666666";d=0;for(b=m.length-3;d<b;d+=2)l=m[d],s=m[d+1],x=m[d+2],t=m[d+3],v=oa(l,s,e),n=oa(x,t,e),f[B]&&(s=oa(l,s,g),t=oa(x,t,g),l=s.x,s=s.y,x=t.x,t=t.y),(x-l)*(v.y-s)>(v.x-l)*(t-s)&&
(D.fillStyle=l<x&&s<t||l>x&&s>t?f[P][1]||Ba:f[P][0]||U,Y([x,t,l,s,v.x,v.y,n.x,n.y],!0)),h[d]=v.x,h[d+1]=v.y;D.fillStyle=f[P][2]||ka;D.strokeStyle="#333333";Y(h,!0)}}}}function W(c,a,d,b,f){f.lineWidth=2;var e=d-c,h=b-a,g=aa(e*e+h*h),l=aa(g),j=wa(),p=wa(),m=wa()*l,l=wa()*l;f.bezierCurveTo(c+e*j+h/g*m,a+h*j-e/g*m,c+e*p-h/g*l,a+h*p+e/g*l,d,b)}function Y(c,a){if(c.length){D.beginPath();D.moveTo(c[0],c[1]);for(var d=2,b=c.length;d<b;d+=2)W(c[d-2],c[d-1],c[d],c[d+1],D);D.closePath();a&&D.stroke();D.fill()}}
function oa(c,a,d){return{x:(c-ma)*d+ma<<0,y:(a-na)*d+na<<0}}var y=0,E=0,X=0,J=0,u=0,G=0,K,ha,ra,D,T,S=new j(200,190,180),ta=S.adjustLightness(0.8),R=S.adjustLightness(1.2),U=S+"",Ba=ta+"",ka=R+"",ja,A,p,Q=1,Ca,N=1,Z=za,Aa=20,ia,ma,na,$,la,Da={container:null,items:[],init:function(c){var a=this.container=pa.createElement("DIV");a.style.pointerEvents="none";a.style.position="absolute";a.style.left=0;a.style.top=0;va.init(this.create());ua.init(this.create());D=this.create();c.appendChild(a);return a},
create:function(){var c=pa.createElement("CANVAS");c.style.webkitTransform="translate3d(0,0,0)";c.style.imageRendering="optimizeSpeed";c.style.position="absolute";c.style.left=0;c.style.top=0;var a=c.getContext("2d");a.lineCap="round";a.lineJoin="round";a.lineWidth=1;try{a.mozImageSmoothingEnabled=!1}catch(d){}this.items.push(c);this.container.appendChild(c);return a},setSize:function(c,a){for(var d=this.items,b=0,f=d.length;b<f;b++)d[b].width=c,d[b].height=a}},aa=Math.sqrt,wa=Math.random,va={context:null,
color:new j(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(c){this.context=c;this.setDate((new Date).setHours(10))},render:function(){var c=this.context,a,d,e;c.clearRect(0,0,y,E);if(A&&p&&!(K<Z||la))if(a=b(u+X,G+J),a=Ia(this.date,a.latitude,a.longitude),!(0>=a.altitude)){d=1/xa(a.altitude);e=0.4/d;this.directionX=Ta(a.azimuth)*d;this.directionY=Sa(a.azimuth)*d;this.color.a=e;a=this.color+"";var f,h,g,j,l,m,k,n=u-A.x,z=G-A.y,w,x,s,t,v,q,r,D;c.beginPath();
d=0;for(e=p.length;d<e;d++){g=p[d];x=!1;j=g[H];w=[];f=0;for(h=j.length-1;f<h;f+=2)w[f]=m=j[f]-n,w[f+1]=k=j[f+1]-z,x||(x=0<m&&m<y&&0<k&&k<E);if(x){j=g[V]?g[F]*Q:g[F];g[B]&&(l=g[V]?g[B]*Q:g[B]);m=null;f=0;for(h=w.length-3;f<h;f+=2)k=w[f],s=w[f+1],x=w[f+2],t=w[f+3],r=this.project(k,s,j),D=this.project(x,t,j),g[B]&&(s=this.project(k,s,l),t=this.project(x,t,l),k=s.x,s=s.y,x=t.x,t=t.y),(x-k)*(r.y-s)>(r.x-k)*(t-s)?(1===m&&(W(v,q,k,s,c),v=k,q=s),m=0,f||(c.moveTo(k,s),v=k,q=s),W(v,q,x,t,c),v=x,q=t):(0===m&&
(W(v,q,r.x,r.y,c),v=r.x,q=r.y),m=1,f||(c.moveTo(r.x,r.y),v=r.x,q=r.y),W(v,q,D.x,D.y,c),v=D.x,q=D.y)}}c.fillStyle=a;c.fill()}},project:function(a,b,d){return{x:a+this.directionX*d,y:b+this.directionY*d}},setDate:function(a){this.date=a;this.render()}},ua={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,y,E);if(A&&p&&!(K<Z||la)){var b,d,e,f,g,h,j,l=u-A.x,m=G-A.y,k,n,q,r;a.fillStyle=ka;a.strokeStyle="#666666";b=0;for(d=p.length;b<d;b++){e=
p[b];n=!1;g=e[H];k=[];e=0;for(f=g.length-1;e<f;e+=2)k[e]=h=g[e]-l,k[e+1]=j=g[e+1]-m,n||(n=0<h&&h<y&&0<j&&j<E);if(n){a.beginPath();e=0;for(f=k.length-3;e<f;e+=2)n=k[e],g=k[e+1],e?W(q,r,n,g,a):a.moveTo(n,g),q=n,r=g;a.closePath();a.stroke();a.fill()}}}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)S=j.parse(a.color||a.wallColor),U=S.adjustAlpha(N)+"",ta=S.adjustLightness(0.8),Ba=ta.adjustAlpha(N)+"",R=S.adjustLightness(1.2),ka=R.adjustAlpha(N)+
"";a.roofColor&&(R=j.parse(a.roofColor),ka=R.adjustAlpha(N)+"");ba();return this};this.geoJSON=function(c,b){if("object"===typeof c)q(c,!b);else{var d=pa.documentElement,e=pa.createElement("script");a.jsonpCallback=function(c){delete a.jsonpCallback;d.removeChild(e);q(c,!b)};d.insertBefore(e,d.lastChild).src=c.replace(/\{callback\}/,"jsonpCallback")}return this};this.setCamOffset=function(a,b){ma=X+a;na=E+b};this.setMaxZoom=function(a){Aa=a};this.setDate=function(a){va.setDate(a);return this};this.appendTo=
function(a){return Da.init(a)};this.loadData=e;this.onMoveEnd=function(){var a=b(u,G),g=b(u+y,G+E);ba();A&&(a[fa]>A.n||a[ga]<A.w||g[fa]<A.s||g[ga]>A.e)&&e()};this.onZoomEnd=function(a){la=!1;z(a.zoom);ja?(p=k(ja),ba()):(ca(),e())};this.onZoomStart=function(){la=!0;ba()};this.setOrigin=function(a,b){u=a;G=b};this.setSize=function(a,b){y=a;E=b;X=y/2<<0;J=E/2<<0;ma=X;na=E;$=y/(1.5/(window.devicePixelRatio||1))/xa(45)<<0;Da.setSize(y,E);ia=$-50};this.setZoom=z;this.render=ca;this.screenshot=function(a){a.push(function(b){ba();
for(var d=Da.items,e=0,f=d.length;e<f;e++)b.drawImage(d[e],0,0);a.next()})};T=g};a.OSMBuildings.VERSION="0.1.8a";a.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(a){L.Util.setOptions(this,a)},onMove:function(){var a=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-a.x,this.lastY-a.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=!1;else{var a=L.DomUtil.getPosition(this.map._mapPane),w=this.map.getPixelOrigin();this.lastX=a.x;this.lastY=a.y;this.container.style.left=-a.x+"px";
this.container.style.top=-a.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(w.x-a.x,w.y-a.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var a=L.DomUtil.getPosition(this.map._mapPane),w=this.map.getPixelOrigin();this.osmb.setOrigin(w.x-a.x,w.y-a.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=!0},addTo:function(a){a.addLayer(this);return this},onAdd:function(a){this.map=a;
a=this.map._panes.overlayPane;this.osmb?a.appendChild(this.container):(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(a),this.osmb.maxZoom=this.map._layersMaxZoom);a=L.DomUtil.getPosition(this.map._mapPane);var w=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(w.x-a.x,w.y-a.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-a.x+"px";this.container.style.top=-a.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,
zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(a){a.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);a.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(a,w){return this.osmb.geoJSON(a,w)},setStyle:function(a){return this.osmb.setStyle(a)},
setDate:function(a){return this.osmb.setDate(a)},screenshot:function(a){return this.osmb.screenshot(a)}});
