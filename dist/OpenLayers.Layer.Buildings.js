(function(b){function p(c,e){var k=c[0]-e[0],h=c[1]-e[1];return k*k+h*h}function q(c){for(var e=0,k=0,h=0,b=c.length-3;h<b;h+=2)e+=c[h],k+=c[h+1];c=2*(c.length-2);return[e/c<<0,k/c<<0]}function U(c){var e=c.length/2,k=new aa(e),h=0,b=e-1,l,g,j,C,p=[],q=[],I=[];for(k[h]=k[b]=1;b;){g=0;for(l=h+1;l<b;l++){j=c[2*l];var J=c[2*l+1],m=c[2*h],A=c[2*h+1],G=c[2*b],x=c[2*b+1],K=G-m,B=x-A,H=void 0;if(0!==K||0!==B)H=((j-m)*K+(J-A)*B)/(K*K+B*B),1<H?(m=G,A=x):0<H&&(m+=K*H,A+=B*H);K=j-m;B=J-A;j=K*K+B*B;j>g&&(C=l,
g=j)}2<g&&(k[C]=1,p.push(h),q.push(C),p.push(C),q.push(b));h=p.pop();b=q.pop()}for(l=0;l<e;l++)k[l]&&I.push(c[2*l],c[2*l+1]);return I}var Ea=Ea||Array,aa=aa||Array,g=Math,Na=g.exp,Oa=g.log,Pa=g.sin,Qa=g.cos,wa=g.tan,Ra=g.atan,da=g.min,xa=g.max,pa=document,j,Fa=function(c){var e,k,h;if(0===c.s)e=k=h=c.l;else{h=0.5>c.l?c.l*(1+c.s):c.l+c.s-c.l*c.s;var b=2*c.l-h;c.h/=360;e=X(b,h,c.h+1/3);k=X(b,h,c.h);h=X(b,h,c.h-1/3)}return new j(255*e<<0,255*k<<0,255*h<<0,c.a)},X=function(c,e,k){0>k&&(k+=1);1<k&&(k-=
1);return k<1/6?c+6*(e-c)*k:0.5>k?e:k<2/3?c+6*(e-c)*(2/3-k):c},g=function(c,e,k,b){this.r=c;this.g=e;this.b=k;this.a=4>arguments.length?1:b},Y=g.prototype;Y.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};Y.adjustLightness=function(c){var e=j.toHSLA(this);e.l*=c;e.l=Math.min(1,Math.max(0,e.l));return Fa(e)};Y.adjustAlpha=function(c){return new j(this.r,this.g,this.b,this.a*c)};g.parse=function(c){var e;c+="";if(~c.indexOf("#"))return e=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),
new j(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1);if(e=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new j(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5]):1);if(e=c.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return Fa({h:parseInt(e[1],10),s:parseFloat(e[2]),l:parseFloat(e[3]),a:e[4]?parseFloat(e[5]):1})};g.toHSLA=function(c){var e=c.r/255,b=c.g/255,h=c.b/255,g=Math.max(e,b,h),l=Math.min(e,b,h),
j,C=(g+l)/2,m;if(g===l)j=l=0;else{m=g-l;l=0.5<C?m/(2-g-l):m/(g+l);switch(g){case e:j=(b-h)/m+(b<h?6:0);break;case b:j=(h-e)/m+2;break;case h:j=(e-b)/m+4}j/=6}return{h:360*j,s:l,l:C,a:c.a}};j=g;var Ga,g=Math,w=g.sin,E=g.cos,Sa=g.tan,Ha=g.asin,Ia=g.atan2,S=g.PI,m=180/S,Ta=357.5291/m,Ua=0.98560028/m,Va=1.9148/m,Wa=0.02/m,Xa=3E-4/m,Ya=102.9372/m,Ja=23.45/m,Za=280.16/m,$a=360.9856235/m;Ga=function(c,e,b){b=-b/m;e/=m;c=c.valueOf()/864E5-0.5+2440588;var h=Ta+Ua*(c-2451545),g=Va*w(h)+Wa*w(2*h)+Xa*w(3*h),
g=h+Ya+g+S,h=Ha(w(g)*w(Ja)),g=Ia(w(g)*E(Ja),E(g));b=Za+$a*(c-2451545)-b-g;return{altitude:Ha(w(e)*w(h)+E(e)*E(h)*E(b)),azimuth:Ia(w(b),E(b)*w(e)-Sa(h)*E(e))-S/2}};var ea=Math.PI,Ka=ea/2,ab=ea/4,bb=180/ea,cb=256,ya=14,fa="latitude",ga="longitude",La=3,Ma=4,I=0,C=1,J=2,x=3,qa=4,T=5,O=6;b.OSMBuildings=function(c){function e(a,n){var d={};a/=ha;n/=ha;d[fa]=0>=n?90:1<=n?-90:bb*(2*Ra(Na(ea*(1-2*n)))-Ka);d[ga]=360*(1===a?1:(a%1+1)%1)-180;return d}function g(){if(S&&!(L<ya)){var a=e(B-W,H-K),n=e(B+A+W,H+
G+K);ra&&ra.abort();var d={w:a[ga],n:a[fa],e:n[ga],s:n[fa],z:L},a=S.replace(/\{ *([\w_]+) *\}/g,function(a,n){return d[n]}),F=h,f=new XMLHttpRequest;f.onreadystatechange=function(){4===f.readyState&&f.status&&!(200>f.status||299<f.status)&&f.responseText&&F(JSON.parse(f.responseText))};f.open("GET",a);f.send(null);ra=f}}function h(a){var n,d,F,f,c=[],e=d=0;Z=ya;E(L);ra=null;if(a&&a.meta.z===L){f=a.meta;F=a.data;if(z&&t&&z.z===f.z){d=z.x-f.x;e=z.y-f.y;a=0;for(n=t.length;a<n;a++)c[a]=t[a][J][0]+d+","+
(t[a][J][1]+e)}z=f;t=[];a=0;for(n=F.length;a<n;a++)if(f=[],!(F[a][C]>ia)&&(d=U(F[a][J]),!(8>d.length))){f[J]=d;f[qa]=q(d);f[I]=da(F[a][I],ia);f[C]=F[a][C];d=f[J][0]+","+f[J][1];f[T]=!(c&&~c.indexOf(d));f[x]=[];f[O]=[];d=F[a][La]?j.parse(F[a][La]):null;e=F[a][Ma]?j.parse(F[a][Ma]):null;f[x]=[d||null,d?d.adjustLightness(0.8):null,e?e:d?d.adjustLightness(1.2):Q];for(d=0;3>d;d++)f[x][d]&&(f[O][d]=f[x][d].adjustAlpha(N)+"");t.push(f)}X()}}function m(a,n){var d,F,f=[],c,e,b,y,g,h,k,j,D=za-L;c=0;for(e=a.length;c<
e;c++)if(g=a[c],k=g[C]>>D,!(k>ia)){h=g[J];j=new Ea(h.length);b=0;for(y=h.length-1;b<y;b+=2)d=h[b+1],F=da(1,xa(0,0.5-Oa(wa(ab+Ka*h[b]/180))/ea/2)),d=(d/360+0.5)*ha<<0,F=F*ha<<0,j[b]=d,j[b+1]=F;j=U(j);if(!(8>j.length)){y=[];y[J]=j;y[qa]=q(j);y[I]=da(g[I]>>D,ia);y[C]=k;y[T]=n;y[x]=g[x];y[O]=[];for(b=0;3>b;b++)y[x][b]&&(y[O][b]=y[x][b].adjustAlpha(N)+"");f.push(y)}}return f}function l(a,n,d){void 0===d&&(d=[]);var b,f,c,e=a[0]?a:a.features,g,y,h,k,m,t,D=n?1:0,v=n?0:1;if(e){a=0;for(b=e.length;a<b;a++)l(e[a],
n,d);return d}"Feature"===a.type&&(b=a.geometry,y=a.properties);"Polygon"===b.type&&(g=[b.coordinates]);"MultiPolygon"===b.type&&(g=b.coordinates);if(g){k=y.height;if(y.color||y.wallColor)m=j.parse(y.color||y.wallColor);y.roofColor&&(t=j.parse(y.roofColor));a=0;for(b=g.length;a<b;a++){n=g[a][0];h=[];f=e=0;for(c=n.length;f<c;f++)h.push(n[f][D],n[f][v]),e+=k||n[f][2]||0;if(e){c=f=[];var r=J;for(var s=void 0,u=void 0,z=void 0,A=void 0,B=0,p=void 0,q=void 0,p=0,q=h.length-3;p<q;p+=2)s=h[p],u=h[p+1],z=
h[p+2],A=h[p+3],B+=s*A-z*u;if("CW"!==(0<B/2?"CW":"CCW")){s=[];for(u=h.length-2;0<=u;u-=2)s.push(h[u],h[u+1]);h=s}c[r]=h;f[I]=e/n.length<<0;f[C]=y.minHeight;f[x]=[m||null,m?m.adjustLightness(0.8):null,t?t:m?m.adjustLightness(1.2):Q];d.push(f)}}}return d}function w(a,n){a?(ja=l(a,n),Z=0,E(L),z={n:90,w:-180,s:-90,e:180,x:0,y:0,z:L},t=m(ja,!0),X()):(ja=null,ca())}function E(a){var n,d,b;L=a;ha=cb<<L;a=L;n=Z;d=za;a=da(xa(a,n),d);N=1-da(xa(0+0.4*((a-n)/(d-n)),0),0.4);Aa=R.adjustAlpha(N)+"";Ba=sa.adjustAlpha(N)+
"";ka=Q.adjustAlpha(N)+"";if(t){a=0;for(n=t.length;a<n;a++){b=t[a];b[O]=[];for(d=0;3>d;d++)b[x][d]&&(b[O][d]=b[x][d].adjustAlpha(N)+"")}}}function X(){clearInterval(Ca);P=0;ta.render();Ca=setInterval(function(){P+=0.1;if(1<P){clearInterval(Ca);P=1;for(var a=0,n=t.length;a<n;a++)t[a][T]=0}ua.render();ca()},33)}function ba(){ua.render();ta.render();ca()}function ca(){M.clearRect(0,0,A,G);if(z&&t&&!(L<Z||la)){var a,n,d,b,f,c,e,h,g,j=B-z.x,k=H-z.y,m=ta.getMaxHeight(),l=[ma+j,na+k],D,v,r,s,u,q;t.sort(function(a,
d){return p(d[qa],l)/d[I]-p(a[qa],l)/a[I]});a=0;for(n=t.length;a<n;a++)if(f=t[a],!(f[I]<=m)){v=!1;c=f[J];D=[];d=0;for(b=c.length-1;d<b;d+=2)D[d]=h=c[d]-j,D[d+1]=g=c[d+1]-k,v||(v=0<h&&h<A&&0<g&&g<G);if(v){d=f[T]?f[I]*P:f[I];c=$/($-d);f[C]&&(d=f[T]?f[C]*P:f[C],e=$/($-d));h=[];M.strokeStyle="#666666";d=0;for(b=D.length-3;d<b;d+=2)g=D[d],r=D[d+1],v=D[d+2],s=D[d+3],u=oa(g,r,c),q=oa(v,s,c),f[C]&&(r=oa(g,r,e),s=oa(v,s,e),g=r.x,r=r.y,v=s.x,s=s.y),(v-g)*(u.y-r)>(u.x-g)*(s-r)&&(M.fillStyle=g<v&&r<s||g>v&&r>
s?f[O][1]||Ba:f[O][0]||Aa,Y([v,s,g,r,u.x,u.y,q.x,q.y],!0)),h[d]=u.x,h[d+1]=u.y;M.fillStyle=f[O][2]||ka;M.strokeStyle="#333333";Y(h,!0)}}}}function V(a,b,d,c,f){f.lineWidth=2;var e=d-a,h=c-b,g=aa(e*e+h*h),j=aa(g),k=va(),m=va(),l=va()*j,j=va()*j;f.bezierCurveTo(a+e*k+h/g*l,b+h*k-e/g*l,a+e*m-h/g*j,b+h*m+e/g*j,d,c)}function Y(a,b){if(a.length){M.beginPath();M.moveTo(a[0],a[1]);for(var d=2,c=a.length;d<c;d+=2)V(a[d-2],a[d-1],a[d],a[d+1],M);M.closePath();b&&M.stroke();M.fill()}}function oa(a,b,d){return{x:(a-
ma)*d+ma<<0,y:(b-na)*d+na<<0}}var A=0,G=0,W=0,K=0,B=0,H=0,L,ha,ra,M,S,R=new j(200,190,180),sa=R.adjustLightness(0.8),Q=R.adjustLightness(1.2),Aa=R+"",Ba=sa+"",ka=Q+"",ja,z,t,P=1,Ca,N=1,Z=ya,za=20,ia,ma,na,$,la,Da={container:null,items:[],init:function(a){var b=this.container=pa.createElement("DIV");b.style.pointerEvents="none";b.style.position="absolute";b.style.left=0;b.style.top=0;ua.init(this.create());ta.init(this.create());M=this.create();a.appendChild(b);return b},create:function(){var a=pa.createElement("CANVAS");
a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var b=a.getContext("2d");b.lineCap="round";b.lineJoin="round";b.lineWidth=1;try{b.mozImageSmoothingEnabled=!1}catch(d){}this.items.push(a);this.container.appendChild(a);return b},setSize:function(a,b){for(var d=this.items,c=0,f=d.length;c<f;c++)d[c].width=a,d[c].height=b}},aa=Math.sqrt,va=Math.random,ua={context:null,color:new j(0,0,0),colorStr:this.color+"",
date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.context=a;this.setDate((new Date).setHours(10))},render:function(){var a=this.context,b,d,c;a.clearRect(0,0,A,G);if(z&&t&&!(L<Z||la))if(b=e(B+W,H+K),b=Ga(this.date,b.latitude,b.longitude),!(0>=b.altitude)){d=1/wa(b.altitude);c=0.4/d;this.directionX=Qa(b.azimuth)*d;this.directionY=Pa(b.azimuth)*d;this.color.a=c;b=this.color+"";var f,h,g,j,k,m,l,p=B-z.x,q=H-z.y,D,v,r,s,u,x,w,E;a.beginPath();d=0;for(c=t.length;d<c;d++){g=t[d];
v=!1;j=g[J];D=[];f=0;for(h=j.length-1;f<h;f+=2)D[f]=m=j[f]-p,D[f+1]=l=j[f+1]-q,v||(v=0<m&&m<A&&0<l&&l<G);if(v){j=g[T]?g[I]*P:g[I];g[C]&&(k=g[T]?g[C]*P:g[C]);m=null;f=0;for(h=D.length-3;f<h;f+=2)l=D[f],r=D[f+1],v=D[f+2],s=D[f+3],w=this.project(l,r,j),E=this.project(v,s,j),g[C]&&(r=this.project(l,r,k),s=this.project(v,s,k),l=r.x,r=r.y,v=s.x,s=s.y),(v-l)*(w.y-r)>(w.x-l)*(s-r)?(1===m&&(V(u,x,l,r,a),u=l,x=r),m=0,f||(a.moveTo(l,r),u=l,x=r),V(u,x,v,s,a),u=v,x=s):(0===m&&(V(u,x,w.x,w.y,a),u=w.x,x=w.y),m=
1,f||(a.moveTo(w.x,w.y),u=w.x,x=w.y),V(u,x,E.x,E.y,a),u=E.x,x=E.y)}}a.fillStyle=b;a.fill()}},project:function(a,b,d){return{x:a+this.directionX*d,y:b+this.directionY*d}},setDate:function(a){this.date=a;this.render()}},ta={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,A,G);if(z&&t&&!(L<Z||la)){var b,d,c,f,e,g,h,j=B-z.x,m=H-z.y,k,l,p,q;a.fillStyle=ka;a.strokeStyle="#666666";b=0;for(d=t.length;b<d;b++){c=t[b];l=!1;e=c[J];k=[];c=0;for(f=
e.length-1;c<f;c+=2)k[c]=g=e[c]-j,k[c+1]=h=e[c+1]-m,l||(l=0<g&&g<A&&0<h&&h<G);if(l){a.beginPath();c=0;for(f=k.length-3;c<f;c+=2)l=k[c],e=k[c+1],c?V(p,q,l,e,a):a.moveTo(l,e),p=l,q=e;a.closePath();a.stroke();a.fill()}}}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)R=j.parse(a.color||a.wallColor),Aa=R.adjustAlpha(N)+"",sa=R.adjustLightness(0.8),Ba=sa.adjustAlpha(N)+"",Q=R.adjustLightness(1.2),ka=Q.adjustAlpha(N)+"";a.roofColor&&(Q=j.parse(a.roofColor),
ka=Q.adjustAlpha(N)+"");ba();return this};this.geoJSON=function(a,c){if("object"===typeof a)w(a,!c);else{var d=pa.documentElement,e=pa.createElement("script");b.jsonpCallback=function(a){delete b.jsonpCallback;d.removeChild(e);w(a,!c)};d.insertBefore(e,d.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}return this};this.setCamOffset=function(a,b){ma=W+a;na=G+b};this.setMaxZoom=function(a){za=a};this.setDate=function(a){ua.setDate(a);return this};this.appendTo=function(a){return Da.init(a)};
this.loadData=g;this.onMoveEnd=function(){var a=e(B,H),b=e(B+A,H+G);ba();z&&(a[fa]>z.n||a[ga]<z.w||b[fa]<z.s||b[ga]>z.e)&&g()};this.onZoomEnd=function(a){la=!1;E(a.zoom);ja?(t=m(ja),ba()):(ca(),g())};this.onZoomStart=function(){la=!0;ba()};this.setOrigin=function(a,b){B=a;H=b};this.setSize=function(a,b){A=a;G=b;W=A/2<<0;K=G/2<<0;ma=W;na=G;$=A/(1.5/(window.devicePixelRatio||1))/wa(45)<<0;Da.setSize(A,G);ia=$-50};this.setZoom=E;this.render=ca;this.screenshot=function(a){a.push(function(b){ba();for(var c=
Da.items,e=0,f=c.length;e<f;e++)b.drawImage(c[e],0,0);a.next()})};S=c};b.OSMBuildings.VERSION="0.1.8a";b.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:!1,alwaysInRange:!0,dxSum:0,dySum:0,initialize:function(b){b=b||{};b.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize.call(this,this.name,b)},setOrigin:function(){var b=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),p=this.map.resolution,q=this.maxExtent,U=Math.round((b.lon-q.left)/p),b=Math.round((q.top-b.lat)/
p);this.osmb.setOrigin(U,b)},setMap:function(b){this.map||OpenLayers.Layer.prototype.setMap.call(this,b);this.osmb||(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(this.div));this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(b){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap.call(this,b)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.call(this);
this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},moveTo:function(b,p,q){b=OpenLayers.Layer.prototype.moveTo.call(this,b,p,q);if(!q){q=parseInt(this.map.layerContainerDiv.style.left,10);var U=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-q+"px";this.div.style.top=-U+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);if(p)this.osmb.onZoomEnd({zoom:this.map.zoom});else this.osmb.onMoveEnd();return b},moveByPx:function(b,
p){this.dxSum+=b;this.dySum+=p;var q=OpenLayers.Layer.prototype.moveByPx.call(this,b,p);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return q},geoJSON:function(b,p){return this.osmb.geoJSON(b,p)},setStyle:function(b){return this.osmb.setStyle(b)},setDate:function(b){return this.osmb.setDate(b)}});
