(function(p){function N(n,q){var A=n[0]-q[0],g=n[1]-q[1];return A*A+g*g}function T(n){for(var q=0,A=0,g=0,i=n.length-3;g<i;g+=2){q+=n[g];A+=n[g+1]}n=(n.length-2)*2;return[q/n<<0,A/n<<0]}function xa(n){var q=n.length/2,A=new Oa(q),g=0,i=q-1,m,t,r,G,K=[],O=[],M=[];for(A[g]=A[i]=1;i;){t=0;for(m=g+1;m<i;m++){r=n[m*2];var Y=n[m*2+1],P=n[g*2],L=n[g*2+1],ga=n[i*2],$=n[i*2+1],x=ga-P,u=$-L,D=void 0;if(x!==0||u!==0){D=((r-P)*x+(Y-L)*u)/(x*x+u*u);if(D>1){P=ga;L=$}else if(D>0){P+=x*D;L+=u*D}}x=r-P;u=Y-L;r=x*
x+u*u;if(r>t){G=m;t=r}}if(t>2){A[G]=1;K.push(g);O.push(G);K.push(G);O.push(i)}g=K.pop();i=O.pop()}for(m=0;m<q;m++)A[m]&&M.push(n[m*2],n[m*2+1]);return M}var Pa=Pa||Array,Oa=Oa||Array,ba=Math,Sa=ba.exp,Ta=ba.log,Ua=ba.sin,Va=ba.cos,Fa=ba.tan,Wa=ba.atan,la=ba.min,Ga=ba.max,ya=p.document,X=function(){function n(g,i,m){if(m<0)m+=1;if(m>1)m-=1;if(m<1/6)return g+(i-g)*6*m;if(m<0.5)return i;if(m<2/3)return g+(i-g)*(2/3-m)*6;return g}function q(g,i,m,t){this.r=g;this.g=i;this.b=m;this.a=arguments.length<
4?1:t}var A=q.prototype;A.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};A.adjustLightness=function(g){var i=X.toHSLA(this);i.l*=g;i.l=Math.min(1,Math.max(0,i.l));var m,t;if(i.s===0)g=m=t=i.l;else{t=i.l<0.5?i.l*(1+i.s):i.l+i.s-i.l*i.s;var r=2*i.l-t;g=n(r,t,i.h+1/3);m=n(r,t,i.h);t=n(r,t,i.h-1/3)}return new X(g*255<<0,m*255<<0,t*255<<0,i.a)};A.adjustAlpha=function(g){return new X(this.r,this.g,this.b,this.a*g)};q.parse=function(g){g+="";if(~g.indexOf("#")){g=
g.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new X(parseInt(g[1],16),parseInt(g[2],16),parseInt(g[3],16),g[4]?parseInt(g[4],16)/255:1)}if(g=g.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new X(parseInt(g[1],10),parseInt(g[2],10),parseInt(g[3],10),g[4]?parseFloat(g[5],10):1)};q.toHSLA=function(g){var i=g.r/255,m=g.g/255,t=g.b/255,r=Math.max(i,m,t),G=Math.min(i,m,t),K,O=(r+G)/2,M;if(r===G)K=G=0;else{M=r-G;G=O>0.5?M/(2-r-G):M/(r+G);switch(r){case i:K=(m-t)/M+(m<t?6:0);break;case m:K=
(t-i)/M+2;break;case t:K=(i-m)/M+4;break}K/=6}return{h:K,s:G,l:O,a:g.a}};return q}(),Xa=function(){var n=Math,q=n.sin,A=n.cos,g=n.tan,i=n.asin,m=n.atan2,t=n.PI,r=180/t,G=357.5291/r,K=0.98560028/r,O=1.9148/r,M=0.02/r,Y=3.0E-4/r,P=102.9372/r,L=23.45/r,ga=280.16/r,$=360.9856235/r;return function(x,u,D){D=-D/r;u=u/r;x=x.valueOf()/864E5-0.5+2440588;var Q=G+K*(x-2451545),I=O*q(Q)+M*q(2*Q)+Y*q(3*Q);I=Q+P+I+t;Q=i(q(I)*q(L));I=m(q(I)*A(L),A(I));D=ga+$*(x-2451545)-D-I;return{altitude:i(q(u)*q(Q)+A(u)*A(Q)*
A(D)),azimuth:m(q(D),A(D)*q(u)-g(Q)*A(u))-t/2}}}(),ma=Math.PI,Qa=ma/2,Ya=ma/4,Za=180/ma,$a=256,Ha=14,na="latitude",oa="longitude",U=0,R=1,V=2,ca=3,za=4,ha=5,da=6;p.OSMBuildings=function(n){function q(a,c){var b={};a/=pa;c/=pa;b[na]=c<=0?90:c>=1?-90:Za*(2*Wa(Sa(ma*(1-2*c)))-Qa);b[oa]=(a===1?1:(a%1+1)%1)*360-180;return b}function A(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function g(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||
b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function i(){if(!(!Ia||S<Ha)){var a=q(I-D,aa-Q),c=q(I+x+D,aa+u+Q);Aa&&Aa.abort();Aa=g(A(Ia,{w:a[oa],n:a[na],e:c[oa],s:c[na],z:S}),m)}}function m(a){var c,b,d,e=[],f,h=f=0;ja=Ha;O(S);Aa=null;if(!(!a||a.meta.z!==S)){d=a.meta;b=a.data;if(E&&B&&E.z===d.z){f=E.x-d.x;h=E.y-d.y;a=0;for(c=B.length;a<c;a++)e[a]=B[a][V][0]+f+","+(B[a][V][1]+h)}E=d;B=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][R]>
qa)){f=xa(b[a][V]);if(!(f.length<8)){d[V]=f;d[za]=T(f);d[U]=la(b[a][U],qa);d[R]=b[a][R];f=d[V][0]+","+d[V][1];d[ha]=!(e&&~e.indexOf(f));d[ca]=[];d[da]=[];B.push(d)}}}M()}}function t(a,c){var b=[],d,e,f,h,j,l,k,y,v,F=Ja-S;d=0;for(e=a.length;d<e;d++){j=a[d];y=j[R]>>F;if(!(y>qa)){l=j[V];v=new Pa(l.length);f=0;for(h=l.length-1;f<h;f+=2){k=l[f+1];var w=la(1,Ga(0,0.5-Ta(Fa(Ya+Qa*l[f]/180))/ma/2));k={x:(k/360+0.5)*pa<<0,y:w*pa<<0};v[f]=k.x;v[f+1]=k.y}v=xa(v);if(!(v.length<8)){h=[];h[V]=v;h[za]=T(v);h[U]=
la(j[U]>>F,qa);h[R]=y;h[ha]=c;h[ca]=j[ca];h[da]=[];for(f=0;f<3;f++)if(h[ca][f])h[da][f]=h[ca][f].adjustAlpha(Z)+"";b.push(h)}}}return b}function r(a,c){if(typeof a==="object")K(a,!c);else{var b=ya.documentElement,d=ya.createElement("script");p.jsonpCallback=function(e){delete p.jsonpCallback;b.removeChild(d);K(e,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function G(a,c,b){if(b===undefined)b=[];var d,e,f,h=a[0]?a:a.features,j,l,k,y,v,F=c?1:0,w=c?0:1;if(h){d=0;
for(a=h.length;d<a;d++)G(h[d],c,b);return b}if(a.type==="Feature"){j=a.geometry;d=a.properties}if(j.type==="Polygon")l=[j.coordinates];if(j.type==="MultiPolygon")l=j.coordinates;if(l){c=d.height;if(d.color||d.wallColor)y=X.parse(d.color||d.wallColor);if(d.roofColor)v=X.parse(d.roofColor);d=0;for(a=l.length;d<a;d++){h=l[d][0];k=[];e=j=0;for(f=h.length;e<f;e++){k.push(h[e][F],h[e][w]);j+=c||h[e][2]||0}if(j){e=[];f=V;var o=void 0,s=void 0,z=void 0,C=void 0,H=0,J=void 0,ra=void 0;J=0;for(ra=k.length-
3;J<ra;J+=2){o=k[J];s=k[J+1];z=k[J+2];C=k[J+3];H+=o*C-z*s}if((H/2>0?"CW":"CCW")==="CW")k=k;else{o=[];for(s=k.length-2;s>=0;s-=2)o.push(k[s],k[s+1]);k=o}e[f]=k;e[U]=j/h.length<<0;e[ca]=[y||null,y?y.adjustLightness(0.8):null,v?v:y?y.adjustLightness(1.2):ia];b.push(e)}}}return b}function K(a,c){if(a){sa=G(a,c);ja=0;O(S);E={n:90,w:-180,s:-90,e:180,x:0,y:0,z:S};B=t(sa,true);M()}else{sa=null;P()}}function O(a){var c,b,d;S=a;pa=$a<<S;a=S;c=ja;b=Ja;a=la(Ga(a,c),b);Z=1-la(Ga(0+(a-c)/(b-c)*0.4,0),0.4);Ka=ea.adjustAlpha(Z)+
"";La=Ba.adjustAlpha(Z)+"";ta=ia.adjustAlpha(Z)+"";if(B){a=0;for(c=B.length;a<c;a++){d=B[a];d[da]=[];for(b=0;b<3;b++)if(d[ca][b])d[da][b]=d[ca][b].adjustAlpha(Z)+""}}}function M(){clearInterval(Ma);fa=0;Ca.render();Ma=setInterval(function(){fa+=0.1;if(fa>1){clearInterval(Ma);fa=1;for(var a=0,c=B.length;a<c;a++)B[a][ha]=0}Da.render();P()},33)}function Y(){Da.render();Ca.render();P()}function P(){W.clearRect(0,0,x,u);if(!(!E||!B||S<ja||ua)){var a,c,b,d,e,f,h,j,l,k=I-E.x,y=aa-E.y,v=Ca.getMaxHeight(),
F=[va+k,wa+y],w,o,s,z,C,H;B.sort(function(J,ra){return N(ra[za],F)/ra[U]-N(J[za],F)/J[U]});a=0;for(c=B.length;a<c;a++){e=B[a];if(!(e[U]<=v)){o=false;f=e[V];w=[];b=0;for(d=f.length-1;b<d;b+=2){w[b]=j=f[b]-k;w[b+1]=l=f[b+1]-y;o||(o=j>0&&j<x&&l>0&&l<u)}if(o){b=e[ha]?e[U]*fa:e[U];f=ka/(ka-b);if(e[R]){b=e[ha]?e[R]*fa:e[R];h=ka/(ka-b)}j=[];W.strokeStyle="#666666";b=0;for(d=w.length-3;b<d;b+=2){l=w[b];s=w[b+1];o=w[b+2];z=w[b+3];C=$(l,s,f);H=$(o,z,f);if(e[R]){s=$(l,s,h);z=$(o,z,h);l=s.x;s=s.y;o=z.x;z=z.y}if((o-
l)*(C.y-s)>(C.x-l)*(z-s)){W.fillStyle=l<o&&s<z||l>o&&s>z?e[da][1]||La:e[da][0]||Ka;ga([o,z,l,s,C.x,C.y,H.x,H.y],true)}j[b]=C.x;j[b+1]=C.y}W.fillStyle=e[da][2]||ta;W.strokeStyle="#333333";ga(j,true)}}}}}function L(a,c,b,d,e){e.lineWidth=2;var f=b-a,h=d-c,j=Ra(f*f+h*h),l=Ra(j),k=Ea(),y=Ea(),v=Ea()*l;l=Ea()*l;e.bezierCurveTo(a+f*k+h/j*v,c+h*k-f/j*v,a+f*y-h/j*l,c+h*y+f/j*l,b,d)}function ga(a,c){if(a.length){W.beginPath();W.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)L(a[b-2],a[b-1],a[b],a[b+1],
W);W.closePath();c&&W.stroke();W.fill()}}function $(a,c,b){return{x:(a-va)*b+va<<0,y:(c-wa)*b+wa<<0}}var x=0,u=0,D=0,Q=0,I=0,aa=0,S,pa,Aa,W,Ia,ea=new X(200,190,180),Ba=ea.adjustLightness(0.8),ia=ea.adjustLightness(1.2),Ka=ea+"",La=Ba+"",ta=ia+"",sa,E,B,fa=1,Ma,Z=1,ja=Ha,Ja=20,qa,va,wa,ka,ua,Na={container:null,items:[],init:function(a){var c=this.container=ya.createElement("DIV");c.style.pointerEvents="none";c.style.position="absolute";c.style.left=0;c.style.top=0;Da.init(this.create());Ca.init(this.create());
W=this.create();a.appendChild(c);return c},create:function(){var a=ya.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var c=a.getContext("2d");c.lineCap="round";c.lineJoin="round";c.lineWidth=1;try{c.mozImageSmoothingEnabled=false}catch(b){}this.items.push(a);this.container.appendChild(a);return c},setSize:function(a,c){for(var b=this.items,d=0,e=b.length;d<e;d++){b[d].width=a;b[d].height=
c}}},Ra=Math.sqrt,Ea=Math.random,Da={context:null,color:new X(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.context=a;this.setDate((new Date).setHours(10))},render:function(){var a=this.context,c,b,d;a.clearRect(0,0,x,u);if(!(!E||!B||S<ja||ua)){c=q(I+D,aa+Q);c=Xa(this.date,c.latitude,c.longitude);if(!(c.altitude<=0)){b=1/Fa(c.altitude);d=0.4/b;this.directionX=Va(c.azimuth)*b;this.directionY=Ua(c.azimuth)*b;this.color.a=d;c=this.color+"";var e,
f,h,j,l,k,y=I-E.x,v=aa-E.y,F,w,o,s,z,C,H,J;a.beginPath();b=0;for(d=B.length;b<d;b++){h=B[b];w=false;j=h[V];F=[];e=0;for(f=j.length-1;e<f;e+=2){F[e]=l=j[e]-y;F[e+1]=k=j[e+1]-v;w||(w=l>0&&l<x&&k>0&&k<u)}if(w){j=h[ha]?h[U]*fa:h[U];if(h[R])j=h[ha]?h[R]*fa:h[R];l=null;e=0;for(f=F.length-3;e<f;e+=2){k=F[e];o=F[e+1];w=F[e+2];s=F[e+3];H=this.project(k,o,j);J=this.project(w,s,j);if(h[R]){o=this.project(k,o,j);s=this.project(w,s,j);k=o.x;o=o.y;w=s.x;s=s.y}if((w-k)*(H.y-o)>(H.x-k)*(s-o)){if(l===1){L(z,C,k,o,
a);z=k;C=o}l=0;if(!e){a.moveTo(k,o);z=k;C=o}L(z,C,w,s,a);z=w;C=s}else{if(l===0){L(z,C,H.x,H.y,a);z=H.x;C=H.y}l=1;if(!e){a.moveTo(H.x,H.y);z=H.x;C=H.y}L(z,C,J.x,J.y,a);z=J.x;C=J.y}}}}a.fillStyle=c;a.fill()}}},project:function(a,c,b){return{x:a+this.directionX*b,y:c+this.directionY*b}},setDate:function(a){this.date=a;this.render()}},Ca={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,x,u);if(!(!E||!B||S<ja||ua)){var c,b,d,e,f,h,j,l=I-E.x,
k=aa-E.y,y,v,F,w;a.fillStyle=ta;a.strokeStyle="#666666";c=0;for(b=B.length;c<b;c++){d=B[c];v=false;f=d[V];y=[];d=0;for(e=f.length-1;d<e;d+=2){y[d]=h=f[d]-l;y[d+1]=j=f[d+1]-k;v||(v=h>0&&h<x&&j>0&&j<u)}if(v){a.beginPath();d=0;for(e=y.length-3;d<e;d+=2){v=y[d];f=y[d+1];d?L(F,w,v,f,a):a.moveTo(v,f);F=v;w=f}a.closePath();a.stroke();a.fill()}}}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){ea=X.parse(a.color||a.wallColor);Ka=ea.adjustAlpha(Z)+
"";Ba=ea.adjustLightness(0.8);La=Ba.adjustAlpha(Z)+"";ia=ea.adjustLightness(1.2);ta=ia.adjustAlpha(Z)+""}if(a.roofColor){ia=X.parse(a.roofColor);ta=ia.adjustAlpha(Z)+""}Y();return this};this.geoJSON=function(a,c){r(a,c);return this};this.setCamOffset=function(a,c){va=D+a;wa=u+c};this.setMaxZoom=function(a){Ja=a};this.setDate=function(a){Da.setDate(a);return this};this.appendTo=function(a){return Na.init(a)};this.loadData=i;this.onMoveEnd=function(){var a=q(I,aa),c=q(I+x,aa+u);Y();if(E&&(a[na]>E.n||
a[oa]<E.w||c[na]<E.s||c[oa]>E.e))i()};this.onZoomEnd=function(a){ua=false;O(a.zoom);if(sa){B=t(sa);Y()}else{P();i()}};this.onZoomStart=function(){ua=true;Y()};this.setOrigin=function(a,c){I=a;aa=c};this.setSize=function(a,c){x=a;u=c;D=x/2<<0;Q=u/2<<0;va=D;wa=u;ka=x/1.5/Fa(45)<<0;Na.setSize(x,u);qa=ka-50};this.setZoom=O;this.render=P;this.screenshot=function(a){a.push(function(c){Y();for(var b=Na.items,d=0,e=b.length;d<e;d++)c.drawImage(b[d],0,0);a.next()})};Ia=n};p.OSMBuildings.VERSION="0.1.8a";p.OSMBuildings.ATTRIBUTION=
'&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(p){p=p||{};p.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,p)},setOrigin:function(){var p=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),N=this.map.resolution,T=this.maxExtent;this.osmb.setOrigin(Math.round((p.lon-T.left)/N),Math.round((T.top-
p.lat)/N))},setMap:function(p){this.map||OpenLayers.Layer.prototype.setMap(p);if(!this.osmb){this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(this.div)}this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(p){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap(p)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,
height:this.map.size.h})},moveTo:function(p,N,T){p=OpenLayers.Layer.prototype.moveTo(p,N,T);if(!T){T=parseInt(this.map.layerContainerDiv.style.left,10);var xa=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-T+"px";this.div.style.top=-xa+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);N?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return p},moveByPx:function(p,N){this.dxSum+=p;this.dySum+=N;var T=OpenLayers.Layer.prototype.moveByPx(p,
N);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return T},geoJSON:function(p,N){return this.osmb.geoJSON(p,N)},setStyle:function(p){return this.osmb.setStyle(p)},setDate:function(p){return this.osmb.setDate(p)}});
